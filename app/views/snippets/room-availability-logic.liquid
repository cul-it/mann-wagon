{% comment %}LibCal Room Availability{% endcomment %}
{% assign available_class = "status--unavailable" %}
{% assign available_icon = "fa-minus-square" %}
{% assign room_availability = "Unavailable" %}
{% assign room_available_icon = "fa-times" %}
{% assign next_available = nil %}
{% assign available_time = nil %}


{% if space.reservation_system.name == "LibCal" %}
  {% assign room_ids = space.reserve_sys_room_ids | split: "," %}
  {% for room_id in room_ids %}
    {% assign room_param = "&room_id=" | append: room_id %}
    {% assign api_request_url = api_request_url | append: room_param%}

    {% consume libcal_api from api_request_url %}
      {% assign libcal_timeslots = libcal_api.availability.timeslots %}
      {% for timeslot in libcal_timeslots %}
        {% comment %}Now available{% endcomment %}
        {% capture available_start_time %}{{timeslot.start | date: '%s'}}{% endcapture %}
        {% capture available_end_time %}{{timeslot.end | date: '%s'}}{% endcapture %}
        {% if available_start_time < current_time and available_end_time > current_time %}
          {% assign available_class = "status--available" %}
          {% assign available_icon = "fa-check-square" %}
          {% assign room_availability = "Available" %}
          {% assign room_available_icon = "fa-check" %}

          {% comment %}Break if loop{% endcomment %}
          {% break %}

        {% comment %}Next available{% endcomment %}
        {% elsif available_start_time > current_time %}

          {% comment %}Break elsif loop if next_available is less than next available_start_time{% endcomment %}
          {% comment %}This logic works only for two rooms in a group{% endcomment %}
          {% if next_available and next_available < available_start_time %}
            {% break %}
          {% endif %}

          {% assign available_class = "status--unavailable" %}
          {% assign available_icon = "fa-minus-square" %}
          {% assign next_available = available_start_time %}
          {% assign room_availability = "Unavailable" %}
          {% assign room_available_icon = "fa-times" %}

          {% break %}

        {% endif %}
      {% endfor %}
    {% endconsume %}

    {% comment %}If room is available, break out of for loop{% endcomment %}
    {% if room_availability == "Available" %}
      {% break %}
    {% endif %}
  {% endfor %}
{% else %}
{% comment %}MannServices Room Availability Logic{% endcomment %}
  {% if space.name == "Grad Rooms" %}
    {% capture available_time %}{{grad_room_next_available | date: '%s'}}{% endcapture %}

    {% comment %}Now available{% endcomment %}
    {% if grad_room_now_available > "0" %}
      {% assign available_class = "status--available" %}
      {% assign available_icon = "fa-check-square" %}
      {% assign room_availability = "Available" %}
      {% assign room_available_icon = "fa-check" %}
    {% else %}
      {% comment %}Next available{% endcomment %}
      {% if available_time > current_time %}
        {% assign available_class = "status--unavailable" %}
        {% assign available_icon = "fa-minus-square" %}
        {% assign next_available = available_time %}
        {% assign room_availability = "Unavailable" %}
        {% assign room_available_icon = "fa-times" %}
      {% endif %}
    {% endif %}
  {% elsif space.name == "Large Group Study Rooms" %}
    {% capture available_time %}{{large_group_room_next_available | date: '%s'}}{% endcapture %}

    {% comment %}Now available{% endcomment %}
    {% if large_group_room_now_available > "0" %}
      {% assign available_class = "status--available" %}
      {% assign available_icon = "fa-check-square" %}
      {% assign room_availability = "Available" %}
      {% assign room_available_icon = "fa-check" %}
    {% else %}
      {% comment %}Next available{% endcomment %}
      {% if available_time > current_time %}
        {% assign available_class = "status--unavailable" %}
        {% assign available_icon = "fa-minus-square" %}
        {% assign next_available = available_time %}
        {% assign room_availability = "Unavailable" %}
        {% assign room_available_icon = "fa-times" %}
      {% endif %}
    {% endif %}
  {% elsif space.name == "Small Group Study Rooms" %}
    {% capture available_time %}{{small_group_room_next_available | date: '%s'}}{% endcapture %}

    {% comment %}Now available{% endcomment %}
    {% if small_group_room_now_available > "0" %}
      {% assign available_class = "status--available" %}
      {% assign available_icon = "fa-check-square" %}
      {% assign room_availability = "Available" %}
      {% assign room_available_icon = "fa-check" %}
    {% else %}
      {% comment %}Next available{% endcomment %}
      {% if available_time > current_time %}
        {% assign available_class = "status--unavailable" %}
        {% assign available_icon = "fa-minus-square" %}
        {% assign next_available = available_time %}
        {% assign room_availability = "Unavailable" %}
        {% assign room_available_icon = "fa-times" %}
      {% endif %}
    {% endif %}

  {% elsif space.name == "Individual Study Rooms" %}
    {% capture available_time %}{{individual_room_next_available | date: '%s'}}{% endcapture %}

    {% comment %}Now available{% endcomment %}
    {% if individual_room_now_available > "0" %}
      {% assign available_class = "status--available" %}
      {% assign available_icon = "fa-check-square" %}
      {% assign room_availability = "Available" %}
      {% assign room_available_icon = "fa-check" %}
    {% else %}
      {% comment %}Next available{% endcomment %}
      {% if available_time > current_time %}
        {% assign available_class = "status--unavailable" %}
        {% assign available_icon = "fa-minus-square" %}
        {% assign next_available = available_time %}
        {% assign room_availability = "Unavailable" %}
        {% assign room_available_icon = "fa-times" %}
      {% endif %}
    {% endif %}
  {% endif %}
{% endif %}
