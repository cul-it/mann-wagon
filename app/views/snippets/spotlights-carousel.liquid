{% comment %} Active spotlights {% endcomment %}
{% with_scope end_date.gte: now, start_date.lte: now %}
  {% assign active_spotlights = contents.spotlights.all %}
{% endwith_scope %}

{% comment %} Fallback spotlights {% endcomment %}
{% with_scope fallback: true %}
  {% assign fallback_spotlights = contents.spotlights.all %}
{% endwith_scope %}

{% comment %} If no active spotlights, default to fallbacks {% endcomment %}
{% if active_spotlights.size == 0 %}
  {% assign falling_back = true %}
  {% assign active_spotlights = fallback_spotlights %}
{% endif %}

{% comment %} Build div containing images for all active spotlights {% endcomment %}
{% capture spotlight_images %}
  <div class="spotlights__images">
    {% for spotlight in active_spotlights %}
      {% capture spotlight_image %}<img src="{{ spotlight.image.url | image_url }}" alt="{{ spotlight.name }}" title="{{ spotlight.caption }}">{% endcapture %}

      {% if spotlight.url %}
        <a href="{{ spotlight.url }}">{{ spotlight_image }}</a>
      {% else %}
        {{ spotlight_image }}
      {% endif %}

      {% comment %} Limit to 2 max for fallback and 5 max otherwise {% endcomment %}
      {% if falling_back and forloop.index == 2 %}
        {% break %}
      {% elsif forloop.index == 5 %}
        {% break %}
      {% endif %}
    {% endfor %}
  </div>
{% endcapture %}

<section class="spotlights">
  <div class="carousel__contain">
    {% comment %} Use carousel if we have multiple active spotlights {% endcomment %}
    {% if active_spotlights.size > 1 %}
      <span class="carousel__nav carousel__nav--prev js-spotlights-prev"><i class="fa fa-angle-left fa-inverse fa-5x"></i></span>

      {{ spotlight_images }}

      <span class="carousel__nav carousel__nav--next js-spotlights-next"><i class="fa fa-angle-right fa-inverse fa-5x"></i></span>

      {{ 'spotlights.bundle.js' | javascript_tag }}

    {% comment %} Otherwise, just display a single image {% endcomment %}
    {% else %}
      {{ spotlight_images }}
    {% endif %}
  </div>
</section>
